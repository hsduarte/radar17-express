<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADAR 17 - Votação</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 60px;
        }
        .voting-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            max-width: 200px;
            margin-bottom: 15px;
        }
        .question-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .question-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .question-text {
            font-size: 1.5rem;
            font-weight: normal;
            margin-bottom: 20px;
        }
        .voting-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        .vote-button {
            padding: 20px;
            font-size: 1.2rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .vote-button:active {
            transform: scale(0.98);
        }
        .vote-button i {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        .team-a-button {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .team-a-button:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        .team-b-button {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .team-b-button:hover {
            background-color: #bb2d3b;
            border-color: #b02a37;
        }
        .status-container {
            margin-top: 20px;
            text-align: center;
        }
        .status-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: inline-block;
        }
        .spinner {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .waiting-container {
            text-align: center;
            padding: 40px 20px;
            background-color: #e9ecef;
            border-radius: 10px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #343a40;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(5px); }
            50% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
        .disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="voting-container">
        <div class="logo-container">
            <h1 id="debate-title">RADAR 17</h1>
            <h3 id="debate-subtitle">Debate Participativo</h3>
        </div>
        
        <div id="active-container">
            <!-- Este contêiner será mostrado quando há uma questão ativa -->
            <div id="question-container" class="question-container">
                <div class="question-title">Questão em discussão:</div>
                <div id="question-text" class="question-text">Carregando...</div>
                
                <div id="voting-buttons" class="voting-buttons">
                    <button id="vote-team-a" class="btn btn-primary vote-button team-a-button" disabled>
                        <i class="bi bi-check-circle-fill"></i>
                        <span id="team-a-text">Equipa A</span>
                    </button>
                    <button id="vote-team-b" class="btn btn-danger vote-button team-b-button" disabled>
                        <i class="bi bi-check-circle-fill"></i>
                        <span id="team-b-text">Equipa B</span>
                    </button>
                </div>
            </div>
            
            <div id="status-container" class="status-container">
                <div id="status-icon" class="status-icon">
                    <i class="bi bi-hourglass spinner"></i>
                </div>
                <div id="status-text" class="alert alert-info">
                    Conectando ao servidor...
                </div>
            </div>
        </div>
        
        <div id="waiting-container" class="waiting-container" style="display: none;">
            <div class="status-icon">
                <i class="bi bi-hourglass spinner"></i>
            </div>
            <h3>Aguardando próxima questão</h3>
            <p class="mt-3 text-muted">
                Quando a próxima questão for apresentada, você poderá votar aqui.
            </p>
        </div>
    </div>
    
    <div class="footer">
        RADAR 17 - Sistema de Debate Participativo © 2025
    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos DOM
            const questionTextEl = document.getElementById('question-text');
            const voteTeamA = document.getElementById('vote-team-a');
            const voteTeamB = document.getElementById('vote-team-b');
            const teamATextEl = document.getElementById('team-a-text');
            const teamBTextEl = document.getElementById('team-b-text');
            const statusIconEl = document.getElementById('status-icon');
            const statusTextEl = document.getElementById('status-text');
            const activeContainerEl = document.getElementById('active-container');
            const waitingContainerEl = document.getElementById('waiting-container');
            const debateTitleEl = document.getElementById('debate-title');
            const debateSubtitleEl = document.getElementById('debate-subtitle');
            
            // Estado
            let currentQuestion = null;
            let isVotingActive = false;
            let hasVoted = false;
            let clientId = null;
            
            // Configuração
            const socket = io();
            
            // Carregar configurações locais (se houver)
            loadSettings();
            
            // Inicializar ID de cliente
            initClientId();
            
            // Socket listeners
            socket.on('connect', () => {
                console.log('Conectado ao servidor');
                updateStatus('Conectado! Aguardando questão...', 'success', 'check-circle-fill');
            });
            
            socket.on('disconnect', () => {
                console.log('Desconectado do servidor');
                updateStatus('Desconectado do servidor. Tentando reconectar...', 'danger', 'wifi-off');
                disableVoting();
            });
            
            // Receber o estado atual ao conectar
            socket.on('currentState', (state) => {
                console.log('Estado atual recebido:', state);
                
                if (state.activeQuestion && state.isVotingActive) {
                    currentQuestion = state.activeQuestion;
                    isVotingActive = state.isVotingActive;
                    
                    // Atualizar a questão
                    questionTextEl.textContent = state.activeQuestion.text;
                    
                    // Verificar se já votou nesta questão
                    checkIfVoted();
                    
                    // Mostrar container de questão ativa
                    activeContainerEl.style.display = 'block';
                    waitingContainerEl.style.display = 'none';
                    
                    // Habilitar votação se não votou
                    if (!hasVoted && isVotingActive) {
                        enableVoting();
                    }
                } else if (state.activeQuestion) {
                    // Questão ativa, mas votação não está aberta
                    currentQuestion = state.activeQuestion;
                    isVotingActive = false;
                    
                    // Atualizar a questão
                    questionTextEl.textContent = state.activeQuestion.text;
                    
                    // Mostrar container de questão ativa
                    activeContainerEl.style.display = 'block';
                    waitingContainerEl.style.display = 'none';
                    
                    // Desabilitar votação
                    disableVoting();
                    updateStatus('Aguardando abertura da votação...', 'warning', 'hourglass-split');
                } else {
                    // Nenhuma questão ativa
                    currentQuestion = null;
                    isVotingActive = false;
                    
                    // Mostrar container de espera
                    activeContainerEl.style.display = 'none';
                    waitingContainerEl.style.display = 'block';
                }
            });
            
            // Quando uma nova questão é ativada
            socket.on('questionActivated', (data) => {
                console.log('Nova questão ativada:', data);
                currentQuestion = data.question;
                isVotingActive = data.isVotingActive;
                
                // Atualizar a questão
                questionTextEl.textContent = data.question.text;
                
                // Resetar estado de votação
                hasVoted = false;
                
                // Mostrar container de questão ativa
                activeContainerEl.style.display = 'block';
                waitingContainerEl.style.display = 'none';
                
                if (isVotingActive) {
                    enableVoting();
                    updateStatus('Nova questão! Vote agora!', 'success', 'check-circle-fill pulse');
                } else {
                    disableVoting();
                    updateStatus('Nova questão! Aguardando abertura da votação...', 'warning', 'hourglass-split');
                }
                
                // Animar aparecimento da questão
                questionTextEl.classList.add('shake');
                setTimeout(() => {
                    questionTextEl.classList.remove('shake');
                }, 500);
            });
            
            // Quando a votação é iniciada
            socket.on('votingStarted', (data) => {
                console.log('Votação iniciada:', data);
                isVotingActive = true;
                
                if (currentQuestion && !hasVoted) {
                    enableVoting();
                    updateStatus('Votação aberta! Escolha uma equipa!', 'success', 'check-circle-fill pulse');
                }
            });
            
            // Quando a votação é finalizada
            socket.on('questionFinalized', (data) => {
                console.log('Questão finalizada:', data);
                isVotingActive = false;
                disableVoting();
                
                if (hasVoted) {
                    updateStatus('Votação encerrada. Seu voto foi registrado!', 'success', 'check-circle-fill');
                } else {
                    updateStatus('Votação encerrada. Você não votou nesta questão.', 'warning', 'exclamation-triangle-fill');
                }
                
                // Aguardar próxima questão após 5 segundos
                setTimeout(() => {
                    if (!isVotingActive && !currentQuestion) {
                        activeContainerEl.style.display = 'none';
                        waitingContainerEl.style.display = 'block';
                    }
                }, 5000);
            });
            
            // Confirmação de voto
            socket.on('voteConfirmed', (data) => {
                console.log('Voto confirmado:', data);
                
                if (currentQuestion && currentQuestion._id === data.questionId) {
                    hasVoted = true;
                    
                    // Salvar informação de voto
                    localStorage.setItem(`voted_${currentQuestion._id}`, 'true');
                    
                    disableVoting();
                    updateStatus('Seu voto foi registrado! Aguardando resultado...', 'success', 'check-circle-fill');
                }
            });
            
            // Mensagens de erro
            socket.on('error', (data) => {
                console.error('Erro:', data);
                updateStatus(`Erro: ${data.message}`, 'danger', 'exclamation-triangle-fill');
            });
    
            // Atualização dos nomes das equipes
            socket.on('teamNamesUpdated', (data) => {
                console.log('Votação: nomes das equipas atualizados:', data);
                
                // Atualizar diretamente os elementos com ID específico
                if (teamATextEl && data.teamAName) {
                    teamATextEl.textContent = data.teamAName;
                }
                
                if (teamBTextEl && data.teamBName) {
                    teamBTextEl.textContent = data.teamBName;
                }
                
                // Atualizar título da página
                document.title = `Votação: ${data.teamAName} vs ${data.teamBName}`;
            });
            
            // Event listeners para botões de votação
            voteTeamA.addEventListener('click', () => {
                if (currentQuestion && isVotingActive && !hasVoted) {
                    submitVote('A');
                    voteTeamA.classList.add('disabled');
                    voteTeamB.classList.add('disabled');
                    updateStatus('Enviando seu voto...', 'info', 'arrow-repeat spinner');
                }
            });
            
            voteTeamB.addEventListener('click', () => {
                if (currentQuestion && isVotingActive && !hasVoted) {
                    submitVote('B');
                    voteTeamA.classList.add('disabled');
                    voteTeamB.classList.add('disabled');
                    updateStatus('Enviando seu voto...', 'info', 'arrow-repeat spinner');
                }
            });
            
            // Funções auxiliares
            function submitVote(team) {
                socket.emit('submitVote', { 
                    teamVoted: team, 
                    questionId: currentQuestion._id,
                    clientId: clientId
                });
            }
            
            function enableVoting() {
                if (!hasVoted && isVotingActive) {
                    voteTeamA.disabled = false;
                    voteTeamB.disabled = false;
                    voteTeamA.classList.remove('disabled');
                    voteTeamB.classList.remove('disabled');
                }
            }
            
            function disableVoting() {
                voteTeamA.disabled = true;
                voteTeamB.disabled = true;
            }
            
            function updateStatus(message, type, icon) {
                statusTextEl.className = `alert alert-${type}`;
                statusTextEl.textContent = message;
                
                statusIconEl.innerHTML = `<i class="bi bi-${icon}"></i>`;
                
                if (icon.includes('spinner') || icon.includes('pulse')) {
                    statusIconEl.querySelector('i').classList.add('spinner');
                } else if (icon.includes('pulse')) {
                    statusIconEl.querySelector('i').classList.add('pulse');
                } else {
                    statusIconEl.querySelector('i').classList.remove('spinner', 'pulse');
                }
            }
            
            function checkIfVoted() {
                if (currentQuestion) {
                    const votedFlag = localStorage.getItem(`voted_${currentQuestion._id}`);
                    hasVoted = votedFlag === 'true';
                    
                    if (hasVoted) {
                        disableVoting();
                        updateStatus('Você já votou nesta questão!', 'info', 'check-square-fill');
                    }
                }
            }
            
            function initClientId() {
                // Verificar se já existe um ID de cliente
                clientId = localStorage.getItem('clientId');
                
                // Se não existir, criar um novo
                if (!clientId) {
                    clientId = generateUUID();
                    localStorage.setItem('clientId', clientId);
                }
                
                console.log('ID do cliente:', clientId);
            }
            
            function generateUUID() {
                // Implementação simples de UUID
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0, 
                        v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            function loadSettings() {
                try {
                    const settingsStr = localStorage.getItem('radar17-settings');
                    if (settingsStr) {
                        const settings = JSON.parse(settingsStr);
                        
                        // Atualizar nomes das equipas
                        if (settings.teamAName) {
                            teamATextEl.textContent = settings.teamAName;
                        }
                        
                        if (settings.teamBName) {
                            teamBTextEl.textContent = settings.teamBName;
                        }
                        
                        // Atualizar título e subtítulo
                        if (settings.debateTitle) {
                            debateTitleEl.textContent = settings.debateTitle;
                        }
                        
                        if (settings.debateSubtitle) {
                            debateSubtitleEl.textContent = settings.debateSubtitle;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar configurações:', error);
                }
            }
        });
    </script>
</body>
</html>